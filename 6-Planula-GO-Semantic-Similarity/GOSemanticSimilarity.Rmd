---
title: "GO Semantic Similarity"
author: "Erin Chille"
date: "Last updated 2021/02/16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Prepare workspace
```{r, message=FALSE, warning=FALSE}
rm(list=ls()) # removes all prior objects
library(tidyverse)
library(org.Hs.eg.db)
library(simplifyEnrichment)
library(magick)
library(dendextend)
library(RColorBrewer)
```

#Cluster 1 (downregulated in low, upregulated in ambient, middle in low)

Load GO data and select only the GO_IDs associated with BP and MF terms
```{r, message=FALSE, warning=FALSE}
clust1.GO <- read_csv("5-Planula-GO-Enrichment-Analysis/Output/GO.05.C1.csv", col_names = TRUE)
nrow(filter(clust1.GO, ontology=="BP")) #BP terms
nrow(filter(clust1.GO, ontology=="CC")) #CC terms
nrow(filter(clust1.GO, ontology=="MF")) #MF terms
clust1.GO.BP <- clust1.GO %>% filter(ontology == "BP")
clust1.BP <- clust1.GO.BP$category
clust1.GO.MF <- clust1.GO %>% filter(ontology == "MF")
clust1.MF <- clust1.GO.MF$category
```

Calculate a similarity clust1 matrix and save the output.
```{r}
#BP Save Cluster Info
# clust1 = GO_similarity(clust1.BP, ont = "BP", db = "org.Hs.eg.db")
# Clust1.BP.clusters <- simplifyGO(clust1, word_cloud_grob_param = list(max_width = 50), max_words=20)
# Clust1.BP.clusters <- arrange(Clust1.BP.clusters, cluster)
# write_csv(Clust1.BP.clusters, "6-Planula-GO-Semantic-Similarity/Output/Clust1.BP.clusters.csv")

#MF Save Cluster Info
# clust1 = GO_similarity(clust1.MF, ont = "MF", db = "org.Hs.eg.db")
# Clust1.MF.clusters <- simplifyGO(clust1, word_cloud_grob_param = list(max_width = 50), max_words=20)
# Clust1.MF.clusters <- arrange(Clust1.MF.clusters, cluster)
# Clust1.MF.clusters
# write_csv(Clust1.MF.clusters, "6-Planula-GO-Semantic-Similarity/Output/Clust1.MF.clusters.csv")
# head(Clust1.MF.clusters)
```
#Cluster 2 (downregulated in ambient, upregulated in low, middle in low)
Load GO data and select only the GO_IDs associated with BP and MF terms
```{r, message=FALSE, warning=FALSE}
clust2.GO <- read_csv("5-Planula-GO-Enrichment-Analysis/Output/GO.05.C2.csv", col_names = TRUE)
nrow(clust2.GO) # total #enriched terms
nrow(filter(clust2.GO, ontology=="BP")) #BP terms
nrow(filter(clust2.GO, ontology=="CC")) #CC terms
nrow(filter(clust2.GO, ontology=="MF")) #MF terms
clust2.GO.BP <- clust2.GO %>% filter(ontology == "BP")
clust2.BP <- clust2.GO.BP$category
clust2.GO.MF <- clust2.GO %>% filter(ontology == "MF")
clust2.MF <- clust2.GO.MF$category
```

Calculate a similarity clust2 matrix and save the output.
```{r}
#BP Save Cluster Info
clust2 = GO_similarity(clust2.BP, ont = "BP", db = "org.Hs.eg.db")
Clust2.BP.clusters <- simplifyGO(clust2, word_cloud_grob_param = list(max_width = 50), max_words=20)
Clust2.BP.clusters <- arrange(Clust2.BP.clusters, cluster)
Clust2.BP.clusters
write_csv(Clust2.BP.clusters, "6-Planula-GO-Semantic-Similarity/Output/Clust2.BP.clusters.csv")

#MF Save Cluster Info
# clust2 = GO_similarity(clust2.MF, ont = "MF", db = "org.Hs.eg.db")
# Clust2.MF.clusters <- simplifyGO(clust2, word_cloud_grob_param = list(max_width = 50), max_words=20)
# Clust2.MF.clusters <- arrange(Clust2.MF.clusters, cluster)
# Clust2.MF.clusters
# write_csv(Clust2.MF.clusters, "6-Planula-GO-Semantic-Similarity/Output/Clust2.MF.clusters.csv")
```

## Make dataframe for heatmap and dendrogram

Dataframe needs profile	percentDEInCat	term	DEgenes associated with cat
```{r}
#merge GO info with cluster info
## cluster 1 has only 6 BP terms, which is too small to cluster, so we will call it one cluster
Clust1.BP.clusters <- clust1.GO.BP
Clust1.BP.clusters$cluster <- 1
Clust1.BP.clusters$percentDEInCat <- (Clust1.BP.clusters$numDEInCat/Clust1.BP.clusters$numInCat)*100
head(Clust1.BP.clusters)

Clust2.BP.clusters <-  merge(clust2.GO.BP, Clust2.BP.clusters, by="term")
Clust2.BP.clusters <- arrange(Clust2.BP.clusters, cluster)
Clust2.BP.clusters <- Clust2.BP.clusters[, c(2:6,1,7,9)]
Clust2.BP.clusters$percentDEInCat <- (Clust2.BP.clusters$numDEInCat/Clust2.BP.clusters$numInCat)*100
head(Clust2.BP.clusters)
```

Make tree
```{r}
C1c <- as.data.frame(Clust1.BP.clusters$cluster)
rownames(C1c) <- Clust1.BP.clusters$term
colnames(C1c) <- "cluster"
C1c <- as.matrix(C1c)
C1c %>%
  dist() %>% 
  hclust() %>% 
  as.dendrogram() -> dend1

#pdf(file="6-Planula-GO-Semantic-Similarity/Output/dendClust1.pdf", height = 5, width= 7)
par(mar = c(2.1, 4.1, 1.1, 20.1))
dend1 %>%
  set("labels_col", k=6) %>%
  set("labels_cex", 0.25) %>%        
  set("leaves_pch", 19) %>%
  set("leaves_cex", 0.5) %>%
  set("leaves_col", k=5) %>% 
  plot(horiz=TRUE, axes=FALSE, main = "Up-regulated in low")
#dev.off()

C2c <- as.data.frame(Clust2.BP.clusters$cluster)
rownames(C2c) <- Clust2.BP.clusters$term
colnames(C2c) <- "cluster"
C2c <- as.matrix(C2c)
C2c %>%
  dist() %>% 
  hclust() %>% 
  as.dendrogram() -> dend2

#pdf(file="6-Planula-GO-Semantic-Similarity/Output/dendClust2.pdf", height = 5, width= 7)
par(mar = c(5.1, 4.1, 4.1, 20.1))
dend2 %>%
  set("labels_col", k=5) %>%
  set("labels_cex", 0.75) %>%        
  set("leaves_pch", 19) %>%
  set("leaves_cex", 0.5) %>%
  set("leaves_col", k=5) %>% 
  plot(horiz=TRUE, axes=FALSE, main = "Up-regulated in low")
#dev.off()

```
